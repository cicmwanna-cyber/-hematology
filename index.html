<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEME-MASTER: ULTIMATE TERMINAL</title>
    <style>
        :root { --main-color: #00ff41; --danger: #ff003c; --bg: #050505; }
        body { background: var(--bg); color: var(--main-color); font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #terminal { width: 90%; max-width: 700px; border: 2px solid var(--main-color); padding: 25px; box-shadow: 0 0 20px rgba(0, 255, 65, 0.2); background: rgba(0,0,0,0.9); }
        .stats-bar { display: flex; justify-content: space-between; border-bottom: 1px solid var(--main-color); padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; }
        #timer-wrap { width: 100%; height: 8px; background: #111; border: 1px solid var(--main-color); margin-bottom: 20px; }
        #timer-fill { width: 100%; height: 100%; background: var(--main-color); transition: width 0.1s linear; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button { background: transparent; border: 1px solid var(--main-color); color: var(--main-color); padding: 15px; cursor: pointer; font-family: inherit; font-size: 1rem; transition: 0.2s; }
        button:hover { background: var(--main-color); color: #000; box-shadow: 0 0 10px var(--main-color); }
        input { background: #000; border: 1px solid var(--main-color); color: var(--main-color); padding: 10px; width: 250px; text-align: center; }
        .hidden { display: none; }
        .warning { color: var(--danger); border-color: var(--danger); }
        #leaderboard { font-size: 0.8rem; margin-top: 20px; opacity: 0.8; }
    </style>
</head>
<body>

<div id="terminal">
    <div id="start-screen">
        <h1>[HEME-MASTER_V3.0]</h1>
        <p>IDENTIFY PHYSICIAN:</p>
        <input type="text" id="player-name" placeholder="DR. NAME">
        <p>SELECT OPERATIONAL MODE:</p>
        <div class="btn-grid">
            <button onclick="setupGame('practice')">PRACTICE (∞ LIVES)</button>
            <button onclick="setupGame('hard')">HARD (3 LIVES)</button>
            <button onclick="setupGame('death')">SUDDEN DEATH (1 LIFE)</button>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="stats-bar">
            <span>NAME: <span id="disp-name"></span></span>
            <span>MODE: <span id="disp-mode"></span></span>
            <span>SCORE: <span id="disp-score">0</span></span>
            <span id="heart-wrap">LIVES: <span id="disp-lives">3</span></span>
        </div>
        <div id="timer-wrap"><div id="timer-fill"></div></div>
        <div id="q-text" style="font-size: 1.3rem; min-height: 80px;"></div>
        <div id="ans-grid" class="btn-grid"></div>
    </div>

    <div id="end-screen" class="hidden">
        <h1 id="end-msg">TERMINATED</h1>
        <p>TOTAL DATA POINTS ACQUIRED: <span id="final-score">0</span></p>
        <button onclick="location.reload()">REBOOT SYSTEM</button>
    </div>

    <div id="leaderboard">
        <h3>GLOBAL_LOG</h3>
        <ul id="score-list"></ul>
    </div>
</div>

<script>
    // AUDIO ENGINE
    const audio = new (window.AudioContext || window.webkitAudioContext)();
    function beep(f, t, d) {
        const o = audio.createOscillator();
        const g = audio.createGain();
        o.type = t; o.frequency.value = f;
        g.gain.setValueAtTime(0.1, audio.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + d);
        o.connect(g); g.connect(audio.destination);
        o.start(); o.stop(audio.currentTime + d);
    }

    // QUESTIONS
    const pool = [
        {q:"Koilonychia and Pica suggest?", a:1, o:["B12 Def.","Iron Def.","SCA","G6PD"]},
        {q:"High MCV + Vegan Diet + Nerve damage?", a:2, o:["Iron","Folate","B12","Lead"]},
        {q:"Bite cells & Heinz bodies after fava beans?", a:3, o:["Spherocytosis","SCA","PNH","G6PD Def."]},
        {q:"Mutation GAG to GTG (Valine swap)?", a:1, o:["Alpha-Thal","Sickle Cell","Beta-Thal","Sideroblastic"]},
        {q:"Target Cells are pathognomonic for?", a:0, o:["Thalassemia","Aplastic","B12 Def.","Marrow Fibrosis"]},
        {q:"Hepcidin levels are high in which anemia?", a:2, o:["Iron Def.","B12 Def.","Chronic Disease","Hemolytic"]},
        {q:"Direct Coombs test looks for?", a:1, o:["RBC shape","Antibodies on RBCs","Free Iron","DNA gaps"]},
        {q:"Classic 'Crew-cut' skull X-ray?", a:0, o:["Thal. Major","Lead Poisoning","Iron Def.","Pernicious Anemia"]},
        {q:"Basophilic stippling suggests?", a:3, o:["B12 Def.","Sickle Cell","Iron Def.","Lead Poisoning"]},
        {q:"PNH is a deficiency in which anchor?", a:2, o:["Albumin","Hemoglobin","GPI-anchor","Ferritin"]}
    ];

    let game = { name:"", mode:"", score:0, lives:3, current:0, timer:null, timeMax:100, speed:1 };

    function setupGame(m) {
        game.name = document.getElementById('player-name').value || "MD_GUEST";
        game.mode = m;
        if(m === 'practice') { game.lives = 99; game.speed = 0.5; }
        if(m === 'hard') { game.lives = 3; game.speed = 1.5; }
        if(m === 'death') { game.lives = 1; game.speed = 2.5; }

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('disp-name').innerText = game.name;
        document.getElementById('disp-mode').innerText = m.toUpperCase();
        document.getElementById('disp-lives').innerText = (m === 'practice' ? '∞' : game.lives);
        
        pool.sort(() => Math.random() - 0.5); // Shuffle
        loadQ();
    }

    function loadQ() {
        if(game.current >= pool.length) return end("SHIFT_COMPLETE");
        const q = pool[game.current];
        document.getElementById('q-text').innerText = `CASE_${game.current+1}: ${q.q}`;
        const grid = document.getElementById('ans-grid');
        grid.innerHTML = '';
        q.o.forEach((o, i) => {
            const b = document.createElement('button');
            b.innerText = o;
            b.onclick = () => check(i);
            grid.appendChild(b);
        });
        startClock();
    }

    function startClock() {
        let val = 100;
        clearInterval(game.timer);
        game.timer = setInterval(() => {
            val -= game.speed;
            document.getElementById('timer-fill').style.width = val + "%";
            if(val < 30) { 
                document.getElementById('timer-fill').style.background = 'red';
                beep(400, 'square', 0.05);
            } else {
                document.getElementById('timer-fill').style.background = 'var(--main-color)';
            }
            if(val <= 0) { handleWrong("TIMEOUT"); }
        }, 100);
    }

    function check(i) {
        clearInterval(game.timer);
        if(i === pool[game.current].a) {
            beep(800, 'sine', 0.2);
            game.score += (game.mode === 'death' ? 500 : 100);
            document.getElementById('disp-score').innerText = game.score;
            game.current++;
            loadQ();
        } else {
            handleWrong("MISDIAGNOSIS");
        }
    }

    function handleWrong(reason) {
        beep(100, 'sawtooth', 0.4);
        game.lives--;
        document.getElementById('disp-lives').innerText = (game.mode === 'practice' ? '∞' : game.lives);
        if(game.lives <= 0) return end(reason);
        game.current++;
        loadQ();
    }

    function end(reason) {
        clearInterval(game.timer);
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('end-msg').innerText = reason;
        document.getElementById('final-score').innerText = game.score;
        save();
    }

    function save() {
        let h = JSON.parse(localStorage.getItem('hemePro')) || [];
        h.push({n: game.name, s: game.score, m: game.mode});
        h.sort((a,b) => b.s - a.s);
        localStorage.setItem('hemePro', JSON.stringify(h.slice(0, 5)));
        renderScores();
    }

    function renderScores() {
        const l = document.getElementById('score-list');
        const h = JSON.parse(localStorage.getItem('hemePro')) || [];
        l.innerHTML = h.map(x => `<li>[${x.m.toUpperCase()}] ${x.n}: ${x.s}</li>`).join('');
    }
    renderScores();
</script>
</body>
</html>
